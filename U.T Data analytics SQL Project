
-- Find the total number of customers who have placed orders. What is the distribution of the customers across states?

      SELECT c.state, COUNT(o.customer_id) as no_of_customers
          FROM customer_t c RIGHT JOIN order_t o
          USING(customer_id)
      Group by State;

-- Which are the top 5 vehicle makers preferred by the customers?

      SELECT
          pt.vehicle_maker, 
          count(ot.customer_id) as no__of_vehicles
              FROM 
                  product_t pt left join order_t ot  
                  USING (product_id)
              GROUP BY pt.vehicle_maker
          ORDER BY no__of_vehicles Desc
      LIMIT 5;

-- Which is the most preferred vehicle maker in each state?

      Select * 
          FROM 
              ( 
          SELECT pt.vehicle_maker, c.state, 
              	       dense_Rank() OVER (Partition by State order by sum(ot.quantity) desc) as rnk 
          FROM customer_t c 
                          right join order_t ot ON c.customer_id = ot.customer_id 
                          join product_t pt ON pt.product_id = ot.product_id 
          GROUP BY pt.vehicle_maker, c.state
          )
           Where rnk = 1


-- Find the overall average rating given by the customers. What is the average rating in each quarter?
Consider the following mapping for ratings: “Very Bad”: 1, “Bad”: 2, “Okay”: 3, “Good”: 4, “Very Good”: 5

      SELECT  quarter_number as Qtr, Round(avg(T1.numerical_rating),2) as avg_rating
          FROM order_t o
          JOIN
       (
                  SELECT customer_feedback, 
                      CASE
                          WHEN customer_feedback = 'Very Bad' then 1
                          WHEN customer_feedback = 'Bad' then 2
                          WHEN customer_feedback = 'Okay' then 3
                          WHEN customer_feedback = 'Good' then 4
                          WHEN customer_feedback = 'Very Good' then 5
                          end as numerical_rating 
                      FROM order_t 
               ) T1 ON t1.customer_feedback = o.customer_feedback
           GROUP BY Qtr;

-- Find the percentage distribution of feedback from the customers. Are customers getting more dissatisfied over time?

Select 
    Quarter_number as Quarter,
    ROUND(CAST(COUNT(CASE WHEN customer_feedback = 'Very Bad' THEN 1 END) AS FLOAT) / COUNT(customer_feedback) * 100,2)  as VeryBadPercent,
    ROUND(CAST(COUNT(CASE WHEN customer_feedback = 'Bad' THEN 1 END) AS FLOAT) / COUNT(customer_feedback) * 100 ,2)  as BadPercent,
    ROUND(CAST(COUNT(CASE WHEN customer_feedback = 'Okay' THEN 1 END) AS FLOAT) / COUNT(customer_feedback) * 100 ,2) as OkayPercent,
    ROUND(CAST(COUNT(CASE WHEN customer_feedback = 'Good' THEN 1 END) AS FLOAT) / COUNT(customer_feedback)* 100, 2)  as GoodPercent,
    ROUND(CAST(COUNT(CASE WHEN customer_feedback = 'Very Good' THEN 1 END) AS FLOAT) / COUNT(customer_feedback) * 100,2)  as VeryGoodPercent
    FROM Order_t
GROUP BY Quarter;


-- What is the trend of the number of orders by quarter?
      
      SELECT 
      quarter_number as Qtr,
       COUNT(order_id) as no_of_orders
      FROM 
      order_t ot 
      GROUP BY Qtr;


-- Calculate the net revenue generated by the company. What is the quarter-over-quarter % change in net revenue?

      SELECT 
          Quarter_number as Qtr,
              ROUND(SUM(quantity * vehicle_price),2) as Revenue,
                  LAG(ROUND(SUM(quantity * vehicle_price),2)) OVER (order by quarter_number) as PreviousRevenue,
                      ROUND(((((ROUND(SUM(quantity * vehicle_price),2)) - 
                  (LAG(ROUND(SUM(quantity * vehicle_price),2)) OVER (order by quarter_number))) /
              (LAG(ROUND(SUM(quantity * vehicle_price),2)) OVER (order by quarter_number)))*100),2) as PercentChange
          FROM Order_t ot 
      GROUP BY quarter_number; 

-- What is the trend of net revenue and orders by quarters?

      SELECT 
          Quarter_number as Qtr,
              ROUND(SUM(quantity * vehicle_price),2) as Revenue,
                  count(order_id) as no_of_orders
          FROM Order_t ot 
      GROUP BY quarter_number;


-- What is the average discount offered for different types of credit cards?

      SELECT 
          c.Credit_card_type as CC_type,
          round(AVG(ot.discount)*100,2) as avg_discount_percent
      FROM customer_t c join order_t ot 
          USING(customer_id)
      GROUP BY c.Credit_card_type;


--- What is the average time taken to ship the placed orders for each quarter?

      SELECT 
          Quarter_number as Qtr,
          ROUND(avg(JULIANDAY(ship_date) - JULIANDAY(order_date)),2) as avg_days_to_ship
      FROM order_t 
      GROUP BY Quarter_number;






